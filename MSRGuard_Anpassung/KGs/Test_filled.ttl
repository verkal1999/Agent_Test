@prefix ag: <http://www.semanticweb.org/AgentProgramParams/> .
@prefix dp: <http://www.semanticweb.org/AgentProgramParams/dp_> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

ag: a owl:Ontology .

ag:GVL__dot__DiagnoseRequested a ag:class_Variable ;
    dp:dp_hasVariableName "GVL__dot__DiagnoseRequested" ;
    dp:dp_hasVariableType "BOOL" .

ag:GVL__dot__Fehler a ag:class_Variable ;
    dp:dp_hasVariableName "GVL__dot__Fehler" ;
    dp:dp_hasVariableType "BOOL" .

ag:GVL__dot__NotStopp a ag:class_Variable ;
    dp:dp_hasInitialValue "TRUE" ;
    dp:dp_hasVariableName "GVL__dot__NotStopp" ;
    dp:dp_hasVariableType "BOOL" .

ag:GVL__dot__Stopp a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "GVL__dot__Stopp" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__Alt_abort a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "OPCUA__dot__Alt_abort" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__Alt_found a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "OPCUA__dot__Alt_found" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__DiagnoseFinished a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "OPCUA__dot__DiagnoseFinished" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__M1 a ag:class_Variable ;
    dp:dp_hasInitialValue "0" ;
    dp:dp_hasVariableName "OPCUA__dot__M1" ;
    dp:dp_hasVariableType "INT" .

ag:OPCUA__dot__M2 a ag:class_Variable ;
    dp:dp_hasInitialValue "0" ;
    dp:dp_hasVariableName "OPCUA__dot__M2" ;
    dp:dp_hasVariableType "INT" .

ag:OPCUA__dot__M3 a ag:class_Variable ;
    dp:dp_hasInitialValue "0" ;
    dp:dp_hasVariableName "OPCUA__dot__M3" ;
    dp:dp_hasVariableType "INT" .

ag:OPCUA__dot__TriggerD1 a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "OPCUA__dot__TriggerD1" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__TriggerD2 a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "OPCUA__dot__TriggerD2" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__TriggerD3 a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "OPCUA__dot__TriggerD3" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__Z1 a ag:class_Variable ;
    dp:dp_hasInitialValue "0" ;
    dp:dp_hasVariableName "OPCUA__dot__Z1" ;
    dp:dp_hasVariableType "INT" .

ag:OPCUA__dot__Z2 a ag:class_Variable ;
    dp:dp_hasInitialValue "0" ;
    dp:dp_hasVariableName "OPCUA__dot__Z2" ;
    dp:dp_hasVariableType "INT" .

ag:OPCUA__dot__Z3 a ag:class_Variable ;
    dp:dp_hasInitialValue "0" ;
    dp:dp_hasVariableName "OPCUA__dot__Z3" ;
    dp:dp_hasVariableType "INT" .

ag:OPCUA__dot__bool1 a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "OPCUA__dot__bool1" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__bool2 a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "OPCUA__dot__bool2" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__bool3 a ag:class_Variable ;
    dp:dp_hasInitialValue "FALSE" ;
    dp:dp_hasVariableName "OPCUA__dot__bool3" ;
    dp:dp_hasVariableType "BOOL" .

ag:OPCUA__dot__lastExecutedProcess a ag:class_Variable ;
    dp:dp_hasInitialValue "''" ;
    dp:dp_hasVariableName "OPCUA__dot__lastExecutedProcess" ;
    dp:dp_hasVariableType "STRING" .

ag:OPCUA__dot__lastExecutedSkill a ag:class_Variable ;
    dp:dp_hasInitialValue "''" ;
    dp:dp_hasVariableName "OPCUA__dot__lastExecutedSkill" ;
    dp:dp_hasVariableType "STRING" .

ag:Program_FB_Automatikbetrieb_F1 a ag:class_Program ;
    dp:hasProgramCode """// POU FB_Automatikbetrieb_F1 body
//GVL.Start := TRUE;
IF GVL.Start THEN
	AutoRestartEnable := TRUE;
END_IF
// === Flanken bilden ===
rStart(CLK := Automatikbetrieb_Starten);
rStep1(CLK := Schritt1);

// === Startsequenz auf positive Flanke, nur wenn nicht bereits aktiv ===
IF (AutoRestartEnable AND NOT (Schritt1 OR Schritt2)) OR (Stoerung_erkannt AND GVL.Weiter) THEN
    // Reset aller Zustände
    Automatikbetrieb_Fertig := FALSE;
    Stoerung_erkannt        := FALSE;
	GVL.Weiter := FALSE;
    // Start in Schritt 1
    Schritt1 := TRUE;
	OPCUA.lastExecutedProcess := 'ExTechnProcess1';
    Schritt2 := FALSE;
END_IF

// === Timer an die Schritte koppeln ===
tSchritt1(IN := Schritt1, PT := T#55S);
tSchritt2(IN := Schritt2, PT := T#55S);

IF rStep1.Q THEN
    lastSkillIsOne := NOT lastSkillIsOne;
    IF lastSkillIsOne THEN
        OPCUA.lastExecutedSkill := 'TestSkill1';
    ELSE
        OPCUA.lastExecutedSkill := 'TestSkill1';
    END_IF
END_IF

IF rStart.Q AND NOT (Schritt1 OR Schritt2) THEN
    Automatikbetrieb_Fertig := FALSE;
    Stoerung_erkannt := FALSE;
    GVL.Weiter := FALSE;
    Schritt1 := TRUE;
    Schritt2 := FALSE;
    OPCUA.lastExecutedProcess := 'ExTechnProcess1';
END_IF

// === Übergänge (sofern keine Störung aktiv ist) ===
IF NOT Stoerung_erkannt THEN
    // Schritt 1 -> 2 nach 30 s
    IF Schritt1 AND tSchritt1.Q THEN
        Schritt1 := FALSE;
        Schritt2 := TRUE;
		OPCUA.lastExecutedSkill := 'TestSkill1';
    END_IF

    // Schritt 2 -> Fertig nach 10 s
    IF Schritt2 AND tSchritt2.Q THEN
        Schritt2 := FALSE;
        Automatikbetrieb_Fertig := TRUE;
        // Hier KEIN automatischer Neustart; neuer Start benötigt erneute Startflanke
    END_IF
END_IF

// === Störungen behandeln (manuell) ===
IF rtStoer.Q THEN
    Stoerung_erkannt := TRUE;
END_IF

/// frei laufender Periodentimer (unabhängig von Schritt1/2) für Störung
tPer(IN := NOT tPer.Q, PT := PeriodicFaultPeriod);  // z.B. T#60s

// Flanke bei Periodenende + definierter Puls
rPer(CLK := tPer.Q);
pPer(IN := rPer.Q, PT := FaultPulse);                // z.B. T#100ms

// nur auslösen, wenn die Automatik gerade läuft
IF (Schritt1 OR Schritt2) AND pPer.Q THEN
    Stoerung_erkannt := TRUE;
	GVL.Fehler := TRUE;
END_IF""" ;
    ag:op_hasInputVariable ag:Var_FB_Automatikbetrieb_F1_AutoRestartEnable,
        ag:Var_FB_Automatikbetrieb_F1_Automatikbetrieb_Starten,
        ag:Var_FB_Automatikbetrieb_F1_FaultPulse,
        ag:Var_FB_Automatikbetrieb_F1_PeriodicFaultEnable,
        ag:Var_FB_Automatikbetrieb_F1_PeriodicFaultPeriod ;
    ag:op_hasInternVariable ag:Var_FB_Automatikbetrieb_F1_lastSkillIsOne ;
    ag:op_hasOutputVariable ag:Var_FB_Automatikbetrieb_F1_Automatikbetrieb_Fertig,
        ag:Var_FB_Automatikbetrieb_F1_Stoerung_erkannt ;
    ag:op_usesVariable ag:Var_FB_Automatikbetrieb_F1_AutoRestartEnable,
        ag:Var_FB_Automatikbetrieb_F1_Automatikbetrieb_Fertig,
        ag:Var_FB_Automatikbetrieb_F1_Automatikbetrieb_Starten,
        ag:Var_FB_Automatikbetrieb_F1_FaultPulse,
        ag:Var_FB_Automatikbetrieb_F1_PeriodicFaultEnable,
        ag:Var_FB_Automatikbetrieb_F1_PeriodicFaultPeriod,
        ag:Var_FB_Automatikbetrieb_F1_Stoerung_erkannt,
        ag:Var_FB_Automatikbetrieb_F1_lastSkillIsOne .

ag:Program_FB_Betriebsarten a ag:class_Program ;
    dp:hasProgramCode """import time

def FB_Betriebsarten(V_10000000001: bool, D2: bool, A5: bool, GVL.Start: bool, A1: bool, D1: bool, D3: bool, V_30000000002: bool, V_30000000005: bool, GVL.Weiter: bool, GVL.NotStopp, A6, V_30000000011: bool, Auto_Stoerung, F1, GVL.DiagnoseRequested, Alt_abort, V_40000000012: bool, Alt_found, D3_Requested, A2, Init_reached, Cycle_ended, A2_Requested, Start_Init):
    \"\"\"Auto-generated from PLCopen XML (vereinfachte Semantik).\"\"\"

    def OR_1(V_10000000002, V_10000000003):
        result = D2 or A5
        return result
    V_10000000004 = OR_1(D2, A5)

    def RS_1(V_10000000001, V_10000000004):
        result = V_10000000004
        return result
    V_10000000005 = RS_1(V_10000000001, V_10000000004)

    def AND_1(V_20000000000, V_20000000001):
        result = GVL.Start and A1
        return result
    V_20000000002 = AND_1(GVL.Start, A1)

    def OR_2(V_20000000003, V_20000000004, V_20000000005):
        result = D2 or D1 or D3
        return result
    V_20000000006 = OR_2(D2, D1, D3)

    def RS_2(V_20000000002, V_20000000006):
        result = V_20000000006
        return result
    V_20000000007 = RS_2(V_20000000002, V_20000000006)

    def AND_2(V_30000000001, V_30000000002):
        result = D1 and V_30000000002
        return result
    V_30000000003 = AND_2(D1, V_30000000002)

    def OR_3(V_30000000000, V_30000000003):
        result = D2 or V_30000000003
        return result
    V_30000000004 = OR_3(D2, V_30000000003)

    def AND_3(V_30000000004, V_30000000005, V_30000000006, V_30000000007):
        result = V_30000000004 and V_30000000005 and GVL.Weiter and GVL.NotStopp
        return result
    V_30000000008 = AND_3(V_30000000004, V_30000000005, GVL.Weiter, GVL.NotStopp)

    def AND_4(V_30000000010, V_30000000011):
        result = D1 and V_30000000011
        return result
    V_30000000012 = AND_4(D1, V_30000000011)

    def OR_4(V_30000000009, V_30000000012):
        result = A6 or V_30000000012
        return result
    V_30000000013 = OR_4(A6, V_30000000012)

    def RS_3(V_30000000008, V_30000000013):
        result = V_30000000013
        return result
    V_30000000014 = RS_3(V_30000000008, V_30000000013)

    def AND_5(V_40000000000, V_40000000001):
        result = Auto_Stoerung and F1
        return result
    V_40000000002 = AND_5(Auto_Stoerung, F1)

    def AND_6(V_40000000003, V_40000000004, V_40000000005):
        result = GVL.DiagnoseRequested and D1 and GVL.NotStopp
        return result
    V_40000000006 = AND_6(GVL.DiagnoseRequested, D1, GVL.NotStopp)

    def AND_7(V_40000000007, V_40000000008):
        result = D3 and Alt_abort
        return result
    V_40000000009 = AND_7(D3, Alt_abort)

    def OR_5(V_40000000002, V_40000000006, V_40000000009):
        result = V_40000000002 or V_40000000006 or V_40000000009
        return result
    V_40000000010 = OR_5(V_40000000002, V_40000000006, V_40000000009)

    def AND_8(V_40000000011, V_40000000012):
        result = D1 and V_40000000012
        return result
    V_40000000013 = AND_8(D1, V_40000000012)

    def OR_6(V_40000000013, V_40000000014, V_40000000015):
        result = V_40000000013 or D3 or A5
        return result
    V_40000000016 = OR_6(V_40000000013, D3, A5)

    def RS_4(V_40000000010, V_40000000016):
        result = V_40000000016
        return result
    V_40000000017 = RS_4(V_40000000010, V_40000000016)

    def AND_9(V_50000000000, V_50000000001):
        result = D2 and Alt_found
        return result
    V_50000000002 = AND_9(D2, Alt_found)

    def AND_10(V_50000000003, V_50000000004):
        result = F1 and D3_Requested
        return result
    V_50000000005 = AND_10(F1, D3_Requested)

    def OR_7(V_50000000002, V_50000000005):
        result = V_50000000002 or V_50000000005
        return result
    V_50000000006 = OR_7(V_50000000002, V_50000000005)

    def OR_8(V_50000000007, V_50000000008, V_50000000009):
        result = A2 or D1 or D2
        return result
    V_50000000010 = OR_8(A2, D1, D2)

    def RS_5(V_50000000006, V_50000000010):
        result = V_50000000010
        return result
    V_50000000011 = RS_5(V_50000000006, V_50000000010)

    def AND_11(V_60000000000, V_60000000001):
        result = A6 and Init_reached
        return result
    V_60000000002 = AND_11(A6, Init_reached)

    def AND_12(V_60000000003, V_60000000004, V_60000000005):
        result = A2 and Init_reached and Cycle_ended
        return result
    V_60000000006 = AND_12(A2, Init_reached, Cycle_ended)

    def OR_9(V_60000000002, V_60000000006):
        result = V_60000000002 or V_60000000006
        return result
    V_60000000007 = OR_9(V_60000000002, V_60000000006)

    def OR_10(V_60000000008, V_60000000009):
        result = F1 or D1
        return result
    V_60000000010 = OR_10(F1, D1)

    def RS_6(V_60000000007, V_60000000010):
        result = V_60000000010
        return result
    V_60000000011 = RS_6(V_60000000007, V_60000000010)

    def AND_13(V_70000000000, V_70000000001):
        result = D3 and A2_Requested
        return result
    V_70000000002 = AND_13(D3, A2_Requested)

    def OR_11(V_70000000003, V_70000000004):
        result = A1 or D1
        return result
    V_70000000005 = OR_11(A1, D1)

    def RS_7(V_70000000002, V_70000000005):
        result = V_70000000005
        return result
    V_70000000006 = RS_7(V_70000000002, V_70000000005)

    def R_TRIG(V_80000000000):
        result = Start_Init
        return result
    V_80000000001 = R_TRIG(Start_Init)

    def OR_12(V_80000000001, V_80000000002):
        result = V_80000000001 or A5
        return result
    V_80000000003 = OR_12(V_80000000001, A5)

    def OR_13(V_80000000004, V_80000000005):
        result = A1 or D1
        return result
    V_80000000006 = OR_13(A1, D1)

    def RS_8(V_80000000003, V_80000000006):
        result = V_80000000006
        return result
    V_80000000007 = RS_8(V_80000000003, V_80000000006)
    D1 = V_10000000005
    print('Value of D1:', D1)
    F1 = V_20000000007
    print('Value of F1:', F1)
    A5 = V_30000000014
    print('Value of A5:', A5)
    D2 = V_40000000017
    print('Value of D2:', D2)
    D3 = V_50000000011
    print('Value of D3:', D3)
    A1 = V_60000000011
    print('Value of A1:', A1)
    A2 = V_70000000006
    print('Value of A2:', A2)
    A6 = V_80000000007
    print('Value of A6:', A6)
    return {'D1': D1, 'F1': F1, 'A5': A5, 'D2': D2, 'D3': D3, 'A1': A1, 'A2': A2, 'A6': A6}""" ;
    ag:op_hasInputVariable ag:Var_FB_Betriebsarten_A2_Requested,
        ag:Var_FB_Betriebsarten_Alt_abort,
        ag:Var_FB_Betriebsarten_Alt_found,
        ag:Var_FB_Betriebsarten_Auto_Fertig,
        ag:Var_FB_Betriebsarten_Auto_Stoerung,
        ag:Var_FB_Betriebsarten_Cycle_ended,
        ag:Var_FB_Betriebsarten_D3_Requested,
        ag:Var_FB_Betriebsarten_Fehler,
        ag:Var_FB_Betriebsarten_Init_reached,
        ag:Var_FB_Betriebsarten_NotStop,
        ag:Var_FB_Betriebsarten_Start,
        ag:Var_FB_Betriebsarten_Start_Init,
        ag:Var_FB_Betriebsarten_Weiter ;
    ag:op_hasInternVariable ag:Var_FB_Betriebsarten_RS_A1,
        ag:Var_FB_Betriebsarten_RS_A2,
        ag:Var_FB_Betriebsarten_RS_A5,
        ag:Var_FB_Betriebsarten_RS_A6,
        ag:Var_FB_Betriebsarten_RS_AutomaticOperationMode,
        ag:Var_FB_Betriebsarten_RS_CycleEnded,
        ag:Var_FB_Betriebsarten_RS_D1,
        ag:Var_FB_Betriebsarten_RS_D2,
        ag:Var_FB_Betriebsarten_RS_D3,
        ag:Var_FB_Betriebsarten_RS_F1,
        ag:Var_FB_Betriebsarten_RS_InitialDrive,
        ag:Var_FB_Betriebsarten_RS_InitialState,
        ag:Var_FB_Betriebsarten_RS_ManualOperationMode,
        ag:Var_FB_Betriebsarten_R_TRIG_Automatic,
        ag:Var_FB_Betriebsarten_R_TRIG_CycleEnded,
        ag:Var_FB_Betriebsarten_R_TRIG_Init,
        ag:Var_FB_Betriebsarten_R_TRIG_InitialDrive,
        ag:Var_FB_Betriebsarten_R_TRIG_Manual,
        ag:Var_FB_Betriebsarten_bFirstScan ;
    ag:op_hasOutputVariable ag:Var_FB_Betriebsarten_A1,
        ag:Var_FB_Betriebsarten_A2,
        ag:Var_FB_Betriebsarten_A5,
        ag:Var_FB_Betriebsarten_A6,
        ag:Var_FB_Betriebsarten_D1,
        ag:Var_FB_Betriebsarten_D2,
        ag:Var_FB_Betriebsarten_D3,
        ag:Var_FB_Betriebsarten_F1,
        ag:Var_FB_Betriebsarten_F4 ;
    ag:op_usesVariable ag:Var_FB_Betriebsarten_A1,
        ag:Var_FB_Betriebsarten_A2,
        ag:Var_FB_Betriebsarten_A2_Requested,
        ag:Var_FB_Betriebsarten_A5,
        ag:Var_FB_Betriebsarten_A6,
        ag:Var_FB_Betriebsarten_Alt_abort,
        ag:Var_FB_Betriebsarten_Alt_found,
        ag:Var_FB_Betriebsarten_Auto_Fertig,
        ag:Var_FB_Betriebsarten_Auto_Stoerung,
        ag:Var_FB_Betriebsarten_Cycle_ended,
        ag:Var_FB_Betriebsarten_D1,
        ag:Var_FB_Betriebsarten_D2,
        ag:Var_FB_Betriebsarten_D3,
        ag:Var_FB_Betriebsarten_D3_Requested,
        ag:Var_FB_Betriebsarten_F1,
        ag:Var_FB_Betriebsarten_F4,
        ag:Var_FB_Betriebsarten_Fehler,
        ag:Var_FB_Betriebsarten_Init_reached,
        ag:Var_FB_Betriebsarten_NotStop,
        ag:Var_FB_Betriebsarten_RS_A1,
        ag:Var_FB_Betriebsarten_RS_A2,
        ag:Var_FB_Betriebsarten_RS_A5,
        ag:Var_FB_Betriebsarten_RS_A6,
        ag:Var_FB_Betriebsarten_RS_AutomaticOperationMode,
        ag:Var_FB_Betriebsarten_RS_CycleEnded,
        ag:Var_FB_Betriebsarten_RS_D1,
        ag:Var_FB_Betriebsarten_RS_D2,
        ag:Var_FB_Betriebsarten_RS_D3,
        ag:Var_FB_Betriebsarten_RS_F1,
        ag:Var_FB_Betriebsarten_RS_InitialDrive,
        ag:Var_FB_Betriebsarten_RS_InitialState,
        ag:Var_FB_Betriebsarten_RS_ManualOperationMode,
        ag:Var_FB_Betriebsarten_R_TRIG_Automatic,
        ag:Var_FB_Betriebsarten_R_TRIG_CycleEnded,
        ag:Var_FB_Betriebsarten_R_TRIG_Init,
        ag:Var_FB_Betriebsarten_R_TRIG_InitialDrive,
        ag:Var_FB_Betriebsarten_R_TRIG_Manual,
        ag:Var_FB_Betriebsarten_Start,
        ag:Var_FB_Betriebsarten_Start_Init,
        ag:Var_FB_Betriebsarten_Weiter,
        ag:Var_FB_Betriebsarten_bFirstScan .

ag:Program_FB_Diagnose_D2 a ag:class_Program ;
    dp:hasProgramCode """// POU FB_Diagnose_D2 body
// 1) Startflanke erkennen
rtReq(CLK := Diagnose_gefordert);

// 2) Einmalig triggern (nur wenn noch nicht "Busy"):
IF rtReq.Q AND NOT Busy THEN
    Busy := TRUE;
	Alt_gefunden := FALSE;
	OPCUA.TriggerD2 := TRUE; 
	OPCUA.bool1 := TRUE;
END_IF

  // {attribute 'OPC.UA.DA' := '1'} in der GVL setzen

// 3) Fertigmeldung vom OPC-UA-Client
//rtFinished(CLK := OPCUA.DiagnoseFinished);
rtAck(CLK := OPCUA.DiagnoseFinished);
rtD3(CLK := OPCUA.Alt_found);
IF rtAck.Q OR rtD3.Q THEN
    Diagnose_beendet := TRUE;
    GVL.Weiter := TRUE;
    Busy := FALSE;
    OPCUA.TriggerD2 := FALSE;
	OPCUA.bool2 := FALSE;
    GVL.Fehler := FALSE;
    Diagnose_gefordert := FALSE;
	GVL.DiagnoseRequested := FALSE;
END_IF
IF rtD3.Q THEN
	Alt_gefunden := TRUE;
END_IF""" ;
    ag:op_hasInputVariable ag:Var_FB_Diagnose_D2_Diagnose_gefordert ;
    ag:op_hasInternVariable ag:Var_FB_Diagnose_D2_Busy,
        ag:Var_FB_Diagnose_D2_rtAck,
        ag:Var_FB_Diagnose_D2_rtD3,
        ag:Var_FB_Diagnose_D2_rtFinished,
        ag:Var_FB_Diagnose_D2_rtReq,
        ag:Var_FB_Diagnose_D2_tpPulse ;
    ag:op_hasOutputVariable ag:Var_FB_Diagnose_D2_Alt_gefunden,
        ag:Var_FB_Diagnose_D2_Diagnose_beendet ;
    ag:op_usesVariable ag:Var_FB_Diagnose_D2_Alt_gefunden,
        ag:Var_FB_Diagnose_D2_Busy,
        ag:Var_FB_Diagnose_D2_Diagnose_beendet,
        ag:Var_FB_Diagnose_D2_Diagnose_gefordert,
        ag:Var_FB_Diagnose_D2_rtAck,
        ag:Var_FB_Diagnose_D2_rtD3,
        ag:Var_FB_Diagnose_D2_rtFinished,
        ag:Var_FB_Diagnose_D2_rtReq,
        ag:Var_FB_Diagnose_D2_tpPulse .

ag:Program_FB_InitFahrt_A6_A2 a ag:class_Program ;
    dp:hasProgramCode """// POU FB_InitFahrt_A6_A2 body
IF A6 THEN
	tInit(IN := A6, PT := T#3S);
ELSIF A2 THEN
	tInit(IN := A2, PT := T#5S);
END_IF

IF tInit.Q THEN
	Init_erreicht := TRUE;
ELSE
	Init_erreicht := FALSE;
END_IF""" ;
    ag:op_hasInputVariable ag:Var_FB_InitFahrt_A6_A2_A2,
        ag:Var_FB_InitFahrt_A6_A2_A6 ;
    ag:op_hasInternVariable ag:Var_FB_InitFahrt_A6_A2_tInit ;
    ag:op_hasOutputVariable ag:Var_FB_InitFahrt_A6_A2_Init_erreicht ;
    ag:op_usesVariable ag:Var_FB_InitFahrt_A6_A2_A2,
        ag:Var_FB_InitFahrt_A6_A2_A6,
        ag:Var_FB_InitFahrt_A6_A2_Init_erreicht,
        ag:Var_FB_InitFahrt_A6_A2_tInit .

ag:Program_FB_Methode1Job a ag:class_Program ;
    dp:hasProgramCode """// METHOD Abort of FB_Methode1Job
running := FALSE;
Abort := 0;

// METHOD CheckState of FB_Methode1Job
// Mehrzyklische Job-Logik:
IF running THEN
	
    //counter := counter + 1;
    //IF counter >= 30 THEN
        //reached := TRUE;
    //END_IF; 
	reached := TRUE;

    // Timer startet erst ab "reached"
    t20s(IN := reached, PT := T#9S);

    IF reached AND t20s.Q THEN
        y := 119;
        running := FALSE;
    END_IF
END_IF

bBusy := running;
yOut  := y;
CheckState := 0;       // 0 = Good (bei Fehler z. B. BadOutOfRange als HRESULT zurückgeben)

// METHOD Start of FB_Methode1Job
// Initialisierung
counter := x;
reached := FALSE;
running := TRUE;
t20s(IN := FALSE, PT := T#9S);   // Timer Reset
hdl := 0;                         // (einfacher Fall)
Start := 0;                       // 0 = OPC UA StatusCode "Good\"""" ;
    ag:op_hasInternVariable ag:Var_FB_Methode1Job_counter,
        ag:Var_FB_Methode1Job_reached,
        ag:Var_FB_Methode1Job_running,
        ag:Var_FB_Methode1Job_t20s,
        ag:Var_FB_Methode1Job_y ;
    ag:op_usesVariable ag:Var_FB_Methode1Job_counter,
        ag:Var_FB_Methode1Job_reached,
        ag:Var_FB_Methode1Job_running,
        ag:Var_FB_Methode1Job_t20s,
        ag:Var_FB_Methode1Job_y .

ag:Program_FB_Notaus_D1 a ag:class_Program ;
    dp:hasProgramCode """// POU FB_Notaus_D1 body
IF D1 THEN
    OPCUA.TriggerD1 := TRUE;         // interne publizierte Variable (kein AT %I*)
    ton5s(IN := TRUE, PT := T#5S);
ELSE
    ton5s(IN := FALSE, PT := T#5S);
END_IF;

IF ton5s.Q THEN
    OPCUA.TriggerD1 := FALSE;
    Diagnose_gefordert := FALSE;
    GVL.NotStopp := TRUE;
    GVL.Fehler := FALSE;
    GVL.Weiter := TRUE;
END_IF;""" ;
    ag:op_hasInputVariable ag:Var_FB_Notaus_D1_D1 ;
    ag:op_hasInternVariable ag:Var_FB_Notaus_D1_ton5s ;
    ag:op_hasOutputVariable ag:Var_FB_Notaus_D1_Diagnose_gefordert,
        ag:Var_FB_Notaus_D1_Notaus_Entriegelt ;
    ag:op_usesVariable ag:Var_FB_Notaus_D1_D1,
        ag:Var_FB_Notaus_D1_Diagnose_gefordert,
        ag:Var_FB_Notaus_D1_Notaus_Entriegelt,
        ag:Var_FB_Notaus_D1_ton5s .

ag:Program_FB_ProduktionMitStoerung_D3 a ag:class_Program ;
    dp:hasProgramCode """// POU FB_ProduktionMitStoerung_D3 body
rStart(CLK := ProduktionMitStoerung_Starten);
IF rStart.Q THEN
	z := 0;
END_IF

IF ProduktionMitStoerung_Starten AND NOT (Schritt3 OR Schritt4) AND NOT Stoerung_erkannt THEN
	Fertig := FALSE;
	Schritt3 := TRUE;
	OPCUA.lastExecutedSkill := 'TestSkill3';
	OPCUA.lastExecutedProcess := 'D3Process';
	Schritt4 := FALSE;
END_IF

tSchritt3(IN := Schritt3, PT:=T#10S);
tSchritt4(IN := Schritt4, PT:=T#10S);

IF tSchritt3.Q THEN
	Schritt3 := FALSE;
	z := z+1;
	IF z > 2 THEN
		Stoerung_erkannt := TRUE;
		OPCUA.Alt_abort := TRUE;
	END_IF
	IF NOT Stoerung_erkannt THEN
		Schritt4 := TRUE;
		OPCUA.lastExecutedSkill := 'TestSkill4';
	END_IF
END_IF

IF tSchritt4.Q THEN
	Schritt4 := FALSE;
	Schritt3 := TRUE;
	OPCUA.lastExecutedSkill := 'TestSkill3';
END_IF""" ;
    ag:op_hasInputVariable ag:Var_FB_ProduktionMitStoerung_D3_ProduktionMitStoerung_Starten ;
    ag:op_hasInternVariable ag:Var_FB_ProduktionMitStoerung_D3_lastSkillIsOne ;
    ag:op_hasOutputVariable ag:Var_FB_ProduktionMitStoerung_D3_Fertig,
        ag:Var_FB_ProduktionMitStoerung_D3_Stoerung_erkannt ;
    ag:op_usesVariable ag:Var_FB_ProduktionMitStoerung_D3_Fertig,
        ag:Var_FB_ProduktionMitStoerung_D3_ProduktionMitStoerung_Starten,
        ag:Var_FB_ProduktionMitStoerung_D3_Stoerung_erkannt,
        ag:Var_FB_ProduktionMitStoerung_D3_lastSkillIsOne .

ag:Program_MAIN a ag:class_Program ;
    dp:hasProgramCode """// POU MAIN body
// Diagnose fertig -> Impuls
edgeDone(CLK := fbDiag.Diagnose_beendet);

// manuell ODER automatisch (Restart nach Diagnose)
Start_eff  := GVL.Start  OR edgeDone.Q;
Weiter_eff := GVL.Weiter OR edgeDone.Q;

// Betriebsarten (RS-F1/RS-D2 sind dort)
fbBA(
    Start         := Start_eff,
    NotStop       := GVL.NotStopp,
    Weiter        := Weiter_eff,
    Fehler        := GVL.Fehler,
	Start_Init 	  := Init_Start,                  
    Auto_Fertig   := fbAuto.Automatikbetrieb_Fertig,
    Auto_Stoerung := fbAuto.Stoerung_erkannt,
	A2_Requested := A2_angefordert,
	Alt_abort := alt_abort,
	Alt_found := alt_found,
	D3_Requested := D3_angefordert,
	Init_reached := Init_erreicht,
	Cycle_ended := Zyklus_beendet
);

// F1-Flanke startet die Automatik
edgeF1(CLK := fbBA.F1);
fbAuto(Automatikbetrieb_Starten := edgeF1.Q);

fbNot(D1 := fbBA.D1);
GVL.DiagnoseRequested := fbNot.Diagnose_gefordert;

fbProStoer(ProduktionMitStoerung_Starten := fbBA.D3);
alt_abort := fbProStoer.Stoerung_erkannt;


fbInit(A6 := fbBA.A6, A2 := fbBA.A2);
Init_erreicht := fbInit.Init_erreicht;

// D2 fordert die Diagnose an
fbDiag(Diagnose_gefordert := fbBA.D2);
alt_found := fbDiag.Alt_gefunden;""" ;
    ag:op_hasInternVariable ag:Var_MAIN_A2_angefordert,
        ag:Var_MAIN_D3_angefordert,
        ag:Var_MAIN_Init_erreicht,
        ag:Var_MAIN_Init_start,
        ag:Var_MAIN_Start_eff,
        ag:Var_MAIN_Weiter_eff,
        ag:Var_MAIN_Zyklus_beendet,
        ag:Var_MAIN_alt_abort,
        ag:Var_MAIN_alt_found,
        ag:Var_MAIN_edgeDone,
        ag:Var_MAIN_edgeF1,
        ag:Var_MAIN_fbAuto,
        ag:Var_MAIN_fbBA,
        ag:Var_MAIN_fbDiag,
        ag:Var_MAIN_fbInit,
        ag:Var_MAIN_fbJob,
        ag:Var_MAIN_fbNot,
        ag:Var_MAIN_fbProStoer ;
    ag:op_usesVariable ag:Var_MAIN_A2_angefordert,
        ag:Var_MAIN_D3_angefordert,
        ag:Var_MAIN_Init_erreicht,
        ag:Var_MAIN_Init_start,
        ag:Var_MAIN_Start_eff,
        ag:Var_MAIN_Weiter_eff,
        ag:Var_MAIN_Zyklus_beendet,
        ag:Var_MAIN_alt_abort,
        ag:Var_MAIN_alt_found,
        ag:Var_MAIN_edgeDone,
        ag:Var_MAIN_edgeF1,
        ag:Var_MAIN_fbAuto,
        ag:Var_MAIN_fbBA,
        ag:Var_MAIN_fbDiag,
        ag:Var_MAIN_fbInit,
        ag:Var_MAIN_fbJob,
        ag:Var_MAIN_fbNot,
        ag:Var_MAIN_fbProStoer .

ag:class_PLCProject a owl:Class .

dp:hasConsistencyReport a owl:DatatypeProperty ;
    rdfs:domain ag:class_Program ;
    rdfs:range xsd:string .

dp:hasDescription a owl:DatatypeProperty ;
    rdfs:domain ag:class_Variable ;
    rdfs:range xsd:string .

dp:hasHardwareAddress a owl:DatatypeProperty ;
    rdfs:domain ag:class_Variable ;
    rdfs:range xsd:string .

dp:hasProgramCode a owl:DatatypeProperty ;
    rdfs:domain ag:class_Program ;
    rdfs:range xsd:string .

dp:hasVariableScope a owl:DatatypeProperty ;
    rdfs:range [ a rdfs:Datatype ;
            owl:oneOf [ a rdf:List ;
                    rdf:first "global" ;
                    rdf:rest [ a rdf:List ;
                            rdf:first "input" ;
                            rdf:rest [ a rdf:List ;
                                    rdf:first "local" ;
                                    rdf:rest [ a rdf:List ;
                                            rdf:first "output" ;
                                            rdf:rest () ] ] ] ] ] .

dp:hasVariableType a owl:DatatypeProperty ;
    rdfs:domain ag:class_Variable ;
    rdfs:range xsd:string .

dp:ioRawXml a owl:DatatypeProperty ;
    rdfs:domain ag:class_Variable ;
    rdfs:range xsd:string .

dp:onlyDeclaredNotUsed a owl:DatatypeProperty ;
    rdfs:domain ag:class_Variable ;
    rdfs:range xsd:boolean .

ag:op_hasIinfluenceOnVariable a owl:ObjectProperty ;
    rdfs:domain ag:class_Variable ;
    rdfs:range ag:class_Variable .

ag:op_hasInputVariable a owl:ObjectProperty ;
    rdfs:domain ag:class_Program ;
    rdfs:range ag:class_Variable ;
    rdfs:subPropertyOf ag:op_usesVariable .

ag:op_hasInternVariable a owl:ObjectProperty ;
    rdfs:domain ag:class_Program ;
    rdfs:range ag:class_Variable ;
    rdfs:subPropertyOf ag:op_usesVariable .

ag:op_hasOutputVariable a owl:ObjectProperty ;
    rdfs:domain ag:class_Program ;
    rdfs:range ag:class_Variable ;
    rdfs:subPropertyOf ag:op_usesVariable .

ag:op_isBoundToChannel a owl:ObjectProperty ;
    rdfs:domain ag:class_Variable ;
    rdfs:range ag:class_IOChannel .

ag:op_isMappedToProgram a owl:ObjectProperty ;
    rdfs:domain ag:class_Variable ;
    rdfs:range ag:class_Program .

ag:op_isMappedToVariable a owl:ObjectProperty ;
    rdfs:domain ag:class_Variable ;
    rdfs:range ag:class_Variable .

ag:op_isSubProgramOf a owl:ObjectProperty ;
    rdfs:domain ag:class_Program ;
    rdfs:range ag:class_Program .

ag:GVL__dot__Start a ag:class_Variable ;
    dp:dp_hasVariableName "GVL__dot__Start" ;
    dp:dp_hasVariableType "BOOL" .

ag:GVL__dot__Weiter a ag:class_Variable ;
    dp:dp_hasVariableName "GVL__dot__Weiter" ;
    dp:dp_hasVariableType "BOOL" .

ag:Var_NOT__leerz__GVL_Fehler a ag:class_Variable .

ag:class_IOChannel a owl:Class .

ag:Var_FB_Automatikbetrieb_F1_AutoRestartEnable a ag:class_Variable .

ag:Var_FB_Automatikbetrieb_F1_Automatikbetrieb_Fertig a ag:class_Variable .

ag:Var_FB_Automatikbetrieb_F1_Automatikbetrieb_Starten a ag:class_Variable .

ag:Var_FB_Automatikbetrieb_F1_FaultPulse a ag:class_Variable .

ag:Var_FB_Automatikbetrieb_F1_PeriodicFaultEnable a ag:class_Variable .

ag:Var_FB_Automatikbetrieb_F1_PeriodicFaultPeriod a ag:class_Variable .

ag:Var_FB_Automatikbetrieb_F1_Stoerung_erkannt a ag:class_Variable .

ag:Var_FB_Automatikbetrieb_F1_lastSkillIsOne a ag:class_Variable .

ag:Var_FB_Betriebsarten_A1 a ag:class_Variable .

ag:Var_FB_Betriebsarten_A2 a ag:class_Variable .

ag:Var_FB_Betriebsarten_A2_Requested a ag:class_Variable .

ag:Var_FB_Betriebsarten_A5 a ag:class_Variable .

ag:Var_FB_Betriebsarten_A6 a ag:class_Variable .

ag:Var_FB_Betriebsarten_Alt_abort a ag:class_Variable .

ag:Var_FB_Betriebsarten_Alt_found a ag:class_Variable .

ag:Var_FB_Betriebsarten_Auto_Fertig a ag:class_Variable .

ag:Var_FB_Betriebsarten_Auto_Stoerung a ag:class_Variable .

ag:Var_FB_Betriebsarten_Cycle_ended a ag:class_Variable .

ag:Var_FB_Betriebsarten_D1 a ag:class_Variable .

ag:Var_FB_Betriebsarten_D2 a ag:class_Variable .

ag:Var_FB_Betriebsarten_D3 a ag:class_Variable .

ag:Var_FB_Betriebsarten_D3_Requested a ag:class_Variable .

ag:Var_FB_Betriebsarten_F1 a ag:class_Variable .

ag:Var_FB_Betriebsarten_F4 a ag:class_Variable .

ag:Var_FB_Betriebsarten_Fehler a ag:class_Variable ;
    ag:op_isMappedToVariable ag:Var_NOT__leerz__GVL_Fehler .

ag:Var_FB_Betriebsarten_Init_reached a ag:class_Variable .

ag:Var_FB_Betriebsarten_NotStop a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_A1 a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_A2 a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_A5 a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_A6 a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_AutomaticOperationMode a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_CycleEnded a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_D1 a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_D2 a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_D3 a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_F1 a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_InitialDrive a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_InitialState a ag:class_Variable .

ag:Var_FB_Betriebsarten_RS_ManualOperationMode a ag:class_Variable .

ag:Var_FB_Betriebsarten_R_TRIG_Automatic a ag:class_Variable .

ag:Var_FB_Betriebsarten_R_TRIG_CycleEnded a ag:class_Variable .

ag:Var_FB_Betriebsarten_R_TRIG_Init a ag:class_Variable .

ag:Var_FB_Betriebsarten_R_TRIG_InitialDrive a ag:class_Variable .

ag:Var_FB_Betriebsarten_R_TRIG_Manual a ag:class_Variable .

ag:Var_FB_Betriebsarten_Start a ag:class_Variable ;
    ag:op_isMappedToVariable ag:GVL__dot__Start .

ag:Var_FB_Betriebsarten_Start_Init a ag:class_Variable .

ag:Var_FB_Betriebsarten_Weiter a ag:class_Variable ;
    ag:op_isMappedToVariable ag:GVL__dot__Weiter .

ag:Var_FB_Betriebsarten_bFirstScan a ag:class_Variable .

ag:Var_FB_Diagnose_D2_Alt_gefunden a ag:class_Variable .

ag:Var_FB_Diagnose_D2_Busy a ag:class_Variable .

ag:Var_FB_Diagnose_D2_Diagnose_beendet a ag:class_Variable .

ag:Var_FB_Diagnose_D2_Diagnose_gefordert a ag:class_Variable .

ag:Var_FB_Diagnose_D2_rtAck a ag:class_Variable .

ag:Var_FB_Diagnose_D2_rtD3 a ag:class_Variable .

ag:Var_FB_Diagnose_D2_rtFinished a ag:class_Variable .

ag:Var_FB_Diagnose_D2_rtReq a ag:class_Variable .

ag:Var_FB_Diagnose_D2_tpPulse a ag:class_Variable .

ag:Var_FB_InitFahrt_A6_A2_A2 a ag:class_Variable .

ag:Var_FB_InitFahrt_A6_A2_A6 a ag:class_Variable .

ag:Var_FB_InitFahrt_A6_A2_Init_erreicht a ag:class_Variable .

ag:Var_FB_InitFahrt_A6_A2_tInit a ag:class_Variable .

ag:Var_FB_Methode1Job_counter a ag:class_Variable .

ag:Var_FB_Methode1Job_reached a ag:class_Variable .

ag:Var_FB_Methode1Job_running a ag:class_Variable .

ag:Var_FB_Methode1Job_t20s a ag:class_Variable .

ag:Var_FB_Methode1Job_y a ag:class_Variable .

ag:Var_FB_Notaus_D1_D1 a ag:class_Variable .

ag:Var_FB_Notaus_D1_Diagnose_gefordert a ag:class_Variable .

ag:Var_FB_Notaus_D1_Notaus_Entriegelt a ag:class_Variable .

ag:Var_FB_Notaus_D1_ton5s a ag:class_Variable .

ag:Var_FB_ProduktionMitStoerung_D3_Fertig a ag:class_Variable .

ag:Var_FB_ProduktionMitStoerung_D3_ProduktionMitStoerung_Starten a ag:class_Variable .

ag:Var_FB_ProduktionMitStoerung_D3_Stoerung_erkannt a ag:class_Variable .

ag:Var_FB_ProduktionMitStoerung_D3_lastSkillIsOne a ag:class_Variable .

ag:Var_MAIN_A2_angefordert a ag:class_Variable .

ag:Var_MAIN_D3_angefordert a ag:class_Variable .

ag:Var_MAIN_Init_erreicht a ag:class_Variable .

ag:Var_MAIN_Init_start a ag:class_Variable .

ag:Var_MAIN_Start_eff a ag:class_Variable .

ag:Var_MAIN_Weiter_eff a ag:class_Variable .

ag:Var_MAIN_Zyklus_beendet a ag:class_Variable .

ag:Var_MAIN_alt_abort a ag:class_Variable .

ag:Var_MAIN_alt_found a ag:class_Variable .

ag:Var_MAIN_edgeDone a ag:class_Variable .

ag:Var_MAIN_edgeF1 a ag:class_Variable .

ag:Var_MAIN_fbAuto a ag:class_Variable .

ag:Var_MAIN_fbBA a ag:class_Variable .

ag:Var_MAIN_fbDiag a ag:class_Variable .

ag:Var_MAIN_fbInit a ag:class_Variable .

ag:Var_MAIN_fbJob a ag:class_Variable .

ag:Var_MAIN_fbNot a ag:class_Variable .

ag:Var_MAIN_fbProStoer a ag:class_Variable .

ag:op_usesVariable a owl:ObjectProperty ;
    rdfs:domain ag:class_Program ;
    rdfs:range ag:class_Variable .

ag:class_Program a owl:Class .

ag:class_Variable a owl:Class .

